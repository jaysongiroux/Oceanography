<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/materialize.css">
    <script src="assets/materialize1.js"></script>
    <script src="assets/depthSalinity.js"></script>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <script src="assets/plotly-latest.min.js"></script>

    <title>Depth and Salinity Mapping</title>
</head>
<body>
<nav>
    <div class="nav-wrapper">
        <a href="#"  id="DEPTHMAP" class="brand-logo" style="padding-left: 10px">Oceanography Toolbox</a>
        <ul id="nav-mobile" class="right hide-on-med-and-down">
            <li><a href="index.html">Home</a></li>
            <li><a href="tools.html">Tools</a></li>
            <li><a href="help.html">Help</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col s12">
            <h3>
                Depth or Salinity Mapping
            </h3>
            <P>
                This tool allows you to enter depth or salinity measurements into a grid and visualize the area measured in a 3D space
            </P>
        </div>
        <div class="col s12">
            <!-- Dropdown Trigger -->
            <a class='dropdown-trigger btn' id="drop2" href='#' data-target='dropdown2'>Choose Input Type</a>

            <!-- Dropdown Structure -->
            <ul id='dropdown2' class='dropdown-content'>
                <li><a href="#!" onclick="ManualInput()">Manual Input</a></li>
                <li><a href="#!" onclick="FileInput()">From File</a></li>
            </ul>
            <!-- Dropdown Trigger -->
            <a class='dropdown-trigger btn' id="drop3" href='#' data-target='dropdown3'>Choose Map Style</a>

            <!-- Dropdown Structure -->
            <ul id='dropdown3' class='dropdown-content'>
                <li><a href="#!" onclick="HeatMap()">Heat Map</a></li>
                <li><a href="#!" onclick="SurfaceMap()">Surface Map</a></li>
            </ul>
        </div>

        <div class="con" id="con" style="display: inline">
            <div class="col s3">

                <p>chart title: </p>
                <input id="title_input" type="text"></input>

                </div>
            <div class="col s3">
                <p>unit: </p>
                <input id="unit_input" type="text"></input>

            </div>
            <div class="col s3">
                <p>height: </p>
                <input id="height_input" type="text"></input>

            </div>
            <div class="col s3">
                <p>width: </p>
                <input id="width_input" type="text"></input>

            </div>
            <div class="col s12">
                <div id="sub" style="padding-top: 10px; text-align: left" onclick="updateTableContainer(); updateUnits();">
                    <a class="waves-effect waves-light btn">Update</a>
            </div>
            <div class="col s12">
                <div class="spacer" style="height: 100px"></div>
            </div>




    <!--        CONTENT -->
            <div class="col s9" id="inputContainer">
                <div id="manualInputContainer" style="display: none">
                    <!--        x AXIS -->
                    <div class="col s3">
                    <!--        space holder-->
                    <div class="space" style="width: 100px;"></div>
                    </div>
                    <div class="col s9">
                        <h5 style="text-align: center" id="xAxis">X(___)</h6>
                        <div class="divider"></div>
                    </div>
                    <!--        Y AXIS START-->
                    <div class="col s3">
                        <h5 id="yAxis" style="text-align: right; margin: fill; height: 100%;">Y(___)</h6>
                    </div>
                    
                    <div class="col s9" id="tableContainer">
                    <!--    TABLE APPEARS HERE-->
                    </div>
                    <div id="sub" style="margin-top: 100px; padding-left: 185px; text-align: left" onclick="clearData()">
                        <br>
                        <a class="waves-effect waves-light btn">Clear Data</a>
                    </div>
                </div>
                <div id="fileInputContainer" style="padding-top: 10px; padding-left: 185px; text-align: left; display: none">
                    <input id="filePicker" type="file">
                </div>
                
            </div>

            <div class="col s12">
                <div id="sub" style="padding-top: 10px; padding-left: 185px; text-align: left" onclick="sub2()">
                    <br>
                    <a class="waves-effect waves-light btn">Submit</a>
                </div>
            </div>
            <div class="col s12">
                <div class="chart" id="chart" style="display: inline"></div>

            </div>
        </div>

    </div>
</div>
</body>
<script>

    // global array of input field DOM elements 
    let height = 0;
    let width = 0;
    let grid = [];

    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('.dropdown-trigger');
        var instances = M.Dropdown.init(elems);

    });
    function updateUnits(){
        let unitInput = document.getElementById("unit_input");
        let unit = unitInput.value;
        document.getElementById("xAxis").innerText = "X(" + unit + ")";
        document.getElementById("yAxis").innerText = "Y(" + unit + ")";
        // document.getElementById("con").style.display = "inline";
    }
    function ManualInput(){
        document.getElementById("drop2").innerText="Manual Input";
        let manualInputContainer = document.getElementById("manualInputContainer");
        let fileInputContainer = document.getElementById("fileInputContainer");
        manualInputContainer.style.display = "inline";
        fileInputContainer.style.display = "none";
    }
    function FileInput(){
        document.getElementById("drop2").innerText="File Input";
        let manualInputContainer = document.getElementById("manualInputContainer");
        let fileInputContainer = document.getElementById("fileInputContainer");
        manualInputContainer.style.display = "none";
        fileInputContainer.style.display = "inline";
    }
    function HeatMap(){
        document.getElementById("drop3").innerText="Heat Map";
    }
    function SurfaceMap(){
        document.getElementById("drop3").innerText="Surface Map";
    }
    function sub(inp){
        z1 = getData(inp);
        if(document.getElementById("drop1").innerText === "DEPTH"){
            var data = [{
                z: z1,
                type: 'surface',
                contours: {
                    z: {
                        show:true,
                        usecolormap: true,
                        highlightcolor:"#42f462",
                        project:{z: true}
                    }
                }
            }];

            let layout = {
                title: 'yes',
            }


            Plotly.newPlot('chart', data, layout);

        }
        else if(document.getElementById("drop").innerText === "SALINITY"){
            var data = [{
                z: z1,
                type: 'heatmap',
            }];


            let layout = {
                title: 'yes',

            }


            Plotly.newPlot('chart', data, layout);
        }

    }
    function sub2(){
        Plotly.d3.csv('assets/test.csv', function(err, rows){
            function unpack(rows, key) {
                return rows.map(function(row) { return row[key]; });
            }
            z1 = getData2();
            title = document.getElementById("title_input").value;
            // [
            //     [1.0,2.0,3.0,4.0,5.0,6.0],
            //     [1.0,1.8,2.6,3.4,4.2,5.0],
            //     [1.0,1.6,2.2,2.8,3.4,4.0],
            //     [1.0,1.4,1.8,2.2,2.6,3.0],
            //     [1.0,1.2,1.4,1.6,1.8,2.0],
            //     [1.0,1.0,1.0,1.0,1.0,1.0]
            // ]
            // for(i=0;i<24;i++)
            // {
            //     z_data.push(unpack(rows,i));
            // }

            var data = [{
                z: z1,
                type: 'surface',
                contours: {
                    z: {
                        show:true,
                        usecolormap: true,
                        highlightcolor:"#42f462",
                        project:{z: true}
                    }
                }
            }];
            
            var layout = {
                title: title,
                autosize: false,
                width: 500,
                height: 500,
                margin: {
                    l: 65,
                    r: 50,
                    b: 65,
                    t: 90,
                }
            };

            Plotly.newPlot('chart', data, layout);
        });
    }
    function clearData(){
        for(i = 0; i < height; i++){
            for(j = 0; j < width; j++){
                grid[i][j].value = "0";
            }
        }
    }
    function updateTableContainer(){
        updateUnits();
        let tableContainer = document.getElementById("tableContainer");
        let newHeight = parseInt(document.getElementById("height_input").value);
        let newWidth = parseInt(document.getElementById("width_input").value);
        if(isNaN(newHeight))
            newHeight = 0;
        if(isNaN(newWidth))
            newWidth = 0;

        if(newHeight != 0 && newWidth != 0){
            let newGrid = [];
            let oldTable = document.getElementById("inputTable");
            let newTable = document.createElement("table");
            newTable.id = "inputTable";
            if(newWidth > 10){
                tableContainer.style = "overflow-x: scroll";
            } else {
                tableContainer.style = "";
            }
            for(i = 0; i < newHeight; i++){
                let row = document.createElement("tr");
                newGrid[i] = [];
                for(j = 0; j < newWidth; j++){
                    let td = document.createElement("td");
                    let input = document.createElement("input");
                    input.style.border = "1px solid black;";
                    input.style.color = "red";
                    input.type = "text";
                    input.id = i + ", " + j;
                    input.addEventListener("focusin", function(){
                        input.style.color = "black";
                        if(input.value.includes(',')){
                            input.value='';
                        }
                    });
                    input.addEventListener("focusout", function(){
                        if(isNaN(parseFloat(input.value))){
                            input.style.color = "red";
                        }
                        if(input.value === ""){
                            input.value = input.id;
                        }
                    });
                    if(i < height && j < width){
                        input.value = grid[i][j].value;
                        if(!isNaN(parseFloat(input.value)) && !input.value.includes(","))
                            input.style.color = "black";
                    } else {
                        input.value = input.id;
                    }
                    td.appendChild(input);
                    if(parseInt(input.width) < 58){
                        input.width = "58";
                    }
                    row.appendChild(td);
                    newGrid[i][j] = input;
                }
                newTable.appendChild(row);
            }
            tableContainer.appendChild(newTable);
            if(oldTable != null){
                oldTable.remove();
            }
            grid = newGrid;
            height = newHeight;
            width = newWidth;
            grid[0][0].focus();
        }
    }

    function getData2(){
        let z = [];
        let filePicker = document.getElementById("filePicker");
        alert(filePicker);
        if(filePicker != null){
            let file = filePicker.files[0];
            if(file != null){
                let reader = new FileReader();
                let text = reader.readAsText(file);
                z = JSON.parse(text);
            }
        } else {
            for(i = 0; i < height; i++){
                z[i] = [];
                for(j = 0; j < width; j++){
                    temp = parseFloat(grid[i][j].value);
                    if(isNaN(temp)){
                        z[i][j] = 0;
                        if(!grid[i][j].value.includes("invalid entry: ")){
                            grid[i][j].value = "invalid entry: " + grid[i][j].value;
                        }
                    } else {
                        z[i][j] = temp;
                    }
                }
            }
        }
        return z;
    }


</script>
</html>